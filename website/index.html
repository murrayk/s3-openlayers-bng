<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OS Vector Tile API | Basic Map (EPSG:27700) | OpenLayers</title>
  <link rel="stylesheet" href="https://labs.os.uk/public/os-api-branding/v0.3.0/os-api-branding.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>

  <div id="map"></div>

  <script src="https://labs.os.uk/public/os-api-branding/v0.3.0/os-api-branding.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ol-mapbox-style@6.1.4/dist/olms.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.0/proj4.js"></script>
  <script>
    const postgisService = 'https://p48vnkse69.execute-api.eu-west-2.amazonaws.com/';
    var apiKey = 'obkg0qQtTEwndqEYQIcTnabftBr1HPFg';

    var serviceUrl = 'https://api.os.uk/maps/vector/v1/vts';

    // Setup the EPSG:27700 (British National Grid) projection.
    //proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs");

    proj4.defs(
      "EPSG:27700",
      `+proj=tmerc +lat_0=49
      +lon_0=-2 +k=0.9996012717
      +x_0=400000 +y_0=-100000
      +ellps=airy +datum=OSGB36
      +units=m +no_defs`
    );
    ol.proj.proj4.register(proj4);

    var map;

    var capabilityPromise = fetch(serviceUrl + '?key=' + apiKey).then(response => response.json());
    var stylePromise = fetch(serviceUrl + '/resources/styles?key=' + apiKey).then(response => response.json());
    var spritePromise = fetch(serviceUrl + '/resources/sprites/sprite.json?key=' + apiKey).then(response => response.json());
    var spriteImageUrl = serviceUrl + '/resources/sprites/sprite.png?key=' + apiKey

    Promise.all([capabilityPromise, stylePromise, spritePromise])
      .then(results => {
        var service = results[0];
        var style = results[1];
        var sprite = results[2];

        /// Read the tile grid dimensions from the service metadata.
        var extent = [service.fullExtent.xmin, service.fullExtent.ymin, service.fullExtent.xmax, service.fullExtent.ymax];
        var origin = [service.tileInfo.origin.x, service.tileInfo.origin.y];

        console.log(origin)
        var resolutions = service.tileInfo.lods.map(l => l.resolution).slice(0, 16);

        console.log("resolutions")
        console.log(resolutions)
        var tileSize = service.tileInfo.rows;
        console.log("tileSize")
        console.log(service.tileInfo.rows)
        console.log(service.tileInfo.rows)
        var tiles = service.tiles[0];
        console.log("url")
        console.log(service.tiles[0])

        // Set up the options required for the VTS source in OpenLayers.
        var options = {
          format: new ol.format.MVT(),
          url: tiles,
          projection: 'EPSG:27700',
          tileGrid: new ol.tilegrid.TileGrid({
            extent,
            origin,
            resolutions,
            tileSize
          })
        };

        var myOptions = {
          format: new ol.format.MVT(),
          url: postgisService + "?x={x}&y={y}&z={z}",
          projection: 'EPSG:27700',
          tileGrid: new ol.tilegrid.TileGrid({
            origin: [0, 0],
            extent: [0, 0, 700000, 1433600],
            resolutions: [
              5734.4, 2867.2, 1433.6, 716.8, 358.4, 179.2, 89.6, 44.8, 22.4, 11.2, 5.6, 2.8, 1.4, 0.7, 0.35,
                0.175, 0.0875,
              ],
            tileSize: 256
          })

        };

    

        var source = new ol.source.VectorTile(options);
        var layer = new ol.layer.VectorTile({ source: source });

        var mySource = new ol.source.VectorTile(myOptions);
        var myLayer = new ol.layer.VectorTile({
          source: mySource, style: new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: 'red',
              width: 1
            })
          })
        });

        var tileUrlFunction = layer.getSource().getTileUrlFunction();
        mySource.on('tileloadend', function (evt) {
          let [z,x,y] = evt.tile.getTileCoord();


          const tilecoord = [z,x,y];
          console.log(tilecoord);
          console.log(layer.getSource().getTileGrid().getTileCoordExtent(tilecoord));
          console.log(tileUrlFunction(evt.tile.getTileCoord(), 1, ol.proj.get('EPSG:27700')));
          console.log("extent for loading tile here" + []);
        });

        // Apply styling function for the vector tile layer.
        olms.stylefunction(layer, style, 'esri', resolutions, sprite, spriteImageUrl);

        // Initialize the map object.
        map = new ol.Map({
          target: 'map',
          layers: [ layer,  myLayer],
          view: new ol.View({
            projection: 'EPSG:27700',
            extent: [0, 0, 700000, 1300000],
            minZoom: 2,
            maxZoom: 15,
            center: [322963.66, 677182],
            zoom: 3
          })
        });
      });

  </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>

</html>
